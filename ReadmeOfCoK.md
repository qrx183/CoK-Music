## 项目流程及功能具体实现

1. 用户模块

   1. 登录

      通过js获取到用户输入的username和passwrod信息,当用户点击登录时,将信息传递给后端,后端拿到这两个参数后会通过username去数据库中查找是否存在对应的user,如果不存在返回报错信息.如果存在,则Bcrypt加密算法验证数据库中的password和前端传来的password是否一致,如果不一致返回报错信息,否则在session中记录该user用户,返回成功登录信息给前端.

   2. 注册

      通过js获取到用户输入的username和password以及repassword(第二次输入的密码),在前端验证password和repassword是否一致,不一致提示报错信息.当用户点击注册时,将信息传递给后端,后端拿到两个参数后首先根据username查询数据库中是否存在对应的user,如果存在返回报错信息(两个user的用户名不能相同),否则创建成功,对密码进行Bcrypt加密后.将新的user存储到数据库的user表中,返回成功注册信息.

   3. 忘记密码

      通过js获取到用户输入的username和password以及repassword(第二次输入的密码),在前端验证password和repassword是否一致,不一致提示报错信息.当用户点击找回时,将信息传递给后端,后端拿到两个参数后首先根据username查询数据库中是否存在对应的user,如果不存在返回报错信息(不存在该用户),否则找回成功,更新user表中user的password属性,返回成功找回信息.

   4. 退出

      通过HttpServletRequest获取到当前用户的session,然后移除掉该会话信息.

2. 功能模块

   1. 播放

      播放功能主要通过前端的audio标签实现,在后端主要是验证是否正常播放.即验证播放文件是否可以正常播放,读取音乐文件的所有内容,如果读取到的为空,说明播放异常,返回异常状态码,否则返回正常状态码.

   2. 收藏

      每一个音乐都有唯一的id,而前端的收藏按钮中的id属性即为音乐的id,当用户点击收藏按钮时,获取到对应的id值,将id值传递给后端.后端拿到id值以后,然后通过HttpSession拿到对应的userId,然后会验证根据id值和userId值去lovemusic表中查找是否存在相应的music,如果存在,说明该音乐已被该用户收藏过,返回已收藏的信息,否则将id值和userId值存储到lovemusic表中,返回成功收藏信息.

   3. 取消收藏

      与收藏功能类似,后端拿到musicId和userId后,将收藏表中对应的音乐记录删除掉.

   4. 上传

      上传音乐依靠MultipartFile.前端通过form表单获取到用户选择的音乐文件以及歌手名传递给后端,后端首先要确定服务器上音乐文件的保存路径Path,然后获取到音乐文件的文件名fileName,通过Path+fileName来将音乐上传到服务器上.在数据库中的music表中,存有title,singer,time,url,userId属性,title即为fileName的xx部分(xx.mp3),singer即前端得到的singer,然后time可以通过Date获取到,url由播放音乐路径+title得到(url主要方便播放音乐).在上传文件之前,我们首先需要判断上传的文件是否已经上传过,相同的音乐指的是音乐文件和歌手都相同.还要判断上传的文件是否为MP3格式的文件,只通过后缀名判断无法有效去除掉其他格式的文件改后缀名得到新文件.通过MP3文件ID3V2中的最后128个字节中的前3个字节的是"TAG"来判断某个文件是不是MP3文件.如果均无误,即可将音乐上传到数据库和服务器.

   5. 删除

      1. 单个删除

         首先前端的删除按钮中的id属性记录了每个音乐独有的id,当点击删除时会将id信息传递给后端,后端通过id从数据库中得到对应的音乐,并通过HttpSession拿到当前用户的userId,比较userId和上传该音乐的id,如果不相同,则没有删除该音乐的权限.返回报错信息,否则分别从数据库和服务器删除音乐.

      2. 多个删除

         首先选中的checkbox中的id属性记录了当前音乐的id,当勾中后,点击"删除选中"按钮后会将所有处于"选中"状态的音乐id放到数组中传到后端,后端拿到id数组后,与"单个删除"相同,先获取到当前登录用户的id,然后和id数组里的每个id比较,如果不相等,说明没有删除音乐的权限,则此次批量删除失败,此时应该利用事务的rollback回滚而不是说删除了一部分.

   6. 查询

      支持模糊查询,当输入为空时查询所有音乐,否则实现模糊查询.然后将查询的所有结果返回给前端.前端拿到音乐数组后,会在js中将音乐数组的内容加载到相应的父类元素下面.然后每次进入页面都会执行一次空的查询,即显示所有已经上传的音乐.